define(["exports"],function(e){"use strict";class t{constructor(){this._webRtcStarted=!1,this._roomName="WebRTCHelper",this._listener=null,this._isCaller=!1,this._debug=!1,this._uuid="",this._peerConnectionConfig={iceServers:[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}]},this._dataChannelOptions={ordered:!1,maxPacketLifeTime:3e3},this._uuid=this._createUUID()}init(e){return"object"==typeof e&&this.debug(e.debug),Promise.resolve(this)}setEventListener(e){this._listener=e}debug(e){return"boolean"==typeof e&&(this._debug=e),this._debug}_issueEvent(e){this._debug&&console.log("_issueEvent(event) "+JSON.stringify(e)),this._listener&&this._listener(e.err,e)}_start(e){this._isCaller=e,this._issueEvent({event:"webRtcStarting",caller:e,room:this._roomName}),this._peerConnection=new RTCPeerConnection(this._peerConnectionConfig),this._peerConnection.onicecandidate=this._gotIceCandidate,e?(this._dataChannel=this._peerConnection.createDataChannel(this._roomName),this._setupDataChannel(),this._peerConnection.createOffer().then(this._createdDescription).catch(this._errorHandler)):this._peerConnection.ondatachannel=(e=>{this._dataChannel=e.channel,this._setupDataChannel()})}_errorHandler(e){this._debug&&console.log(e),this._issueEvent({err:e})}dataChannel(){return this._dataChannel}_setupDataChannel(){this._dataChannel.onopen=(()=>this._issueEvent({event:"dataChanneOpen",dataChannel:this._dataChannel,err:!1})),this._dataChannel.onclose=(()=>this._issueEvent({event:"dataChanneClose",dataChannel:this._dataChannel,err:!1})),this._dataChannel.onmessage=(e=>this._issueEvent({event:"message",data:e,err:!1})),this._dataChannel.onerror=(e=>this._issueEvent({event:"dataChannelError",err:e}))}_gotMessageFromServer(e){this._debug&&console.log(e),this._peerConnection||this._start(!1);let t=e;t.uuid!=this._uuid&&(t.sdp?this._peerConnection.setRemoteDescription(new RTCSessionDescription(t.sdp)).then(function(e){if("offer"==t.sdp.type){e._peerConnection.createAnswer().then(()=>e._createdDescription()).catch(e._errorHandler())}}).catch(this._errorHandler):t.ice&&this._peerConnection.addIceCandidate(new RTCIceCandidate(t.ice)).catch(this._errorHandler))}_gotIceCandidate(e){null!=e.candidate&&t._messaging.send({ice:e.candidate,uuid:this._uuid})}_createdDescription(e){this._debug&&(console.log("Got description"),console.log(e)),this._peerConnection.setLocalDescription(e).then(function(e){e._messaging.send({sdp:e._peerConnection.localDescription,uuid:e._uuid})}).catch(this._errorHandler)}_createUUID(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}_onMessageEvent(e,t){if(!e)switch(t.event){case"message":this._issueEvent({event:"messageFromServer",message:t.message}),this._gotMessageFromServer(t.message);break;case"joined":if(this._webRtcStarted)return;const e=t.clients.length;if(e>=3)return alert("The room is full");let n=!1;if(1==e&&(n=!0),2!==e)return;this._webRtcStarted=!0,this._start(n)}}started(){return this._webRtcStarted}}e.WebRTCHelper=t,e.createWebRTCHelper=async function(e){const n=new t;return await n.init(e||{})},Object.defineProperty(e,"__esModule",{value:!0})});